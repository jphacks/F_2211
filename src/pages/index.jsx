import { collection, getDocs, limit, query } from "firebase/firestore";
import Head from "next/head";
import { useEffect, useRef, useState } from "react";
import Loading from "../components/Loading/loading";
import { db } from "../lib/clientApp";
import styles from "../styles/index.module.css";

import mapboxgl from "mapbox-gl";

mapboxgl.accessToken =
  "pk.eyJ1IjoiaW51aXl1a2kwOTA0IiwiYSI6ImNsOWlmZXozbTBiNG4zdm1yZHoydWRra2oifQ.92mwSImqwWlQK5_-aIm6rg";

const Home = (props) => {
  const { data } = props;

  const mapContainer = useRef(null);
  const map = useRef(null);
  const [lng, setLng] = useState(0);
  const [lat, setLat] = useState(0);

  const createMarkerElement = (shop) => {
    let el = document.createElement("div");
    let img = document.createElement("img");

    img.src = `/stores/${shop.brand_name}.png`;
    img.className = styles["pin-img"];

    el.appendChild(img);

    let ptag = document.createElement("p");

    ptag.textContent = shop.brand_price;
    ptag.setAttribute("class", styles["brand-price"]);
    el.appendChild(ptag);
    return el;
  };

  const createHomeMarkerElement = () => {
    let el = document.createElement("div");
    let img = document.createElement("img");

    img.src = "/user_pin.svg";
    img.className = styles["home-pin-img"];
    el.appendChild(img);
    return el;
  };

  const createPopupHTML = (shop) => {
    return `
      <div class="${styles["shop-container"]}">
        <div class="${styles["shop-top"]}">
          <img src="/stores/${shop.brand_name}.png" width="40px" height="40px" />
          <p class="${styles["shop-name"]}">
              ${shop.store_name}
          </p>
        </div>
        <div class="${styles["shop-bottom"]}">
          <p class="${styles["time-shop"]}">${shop.open_time}</p>
          <p class="${styles["price-shop"]}"><span class="${styles["price-shop-title"]}">最安値：</span>¥${shop.brand_price}</p>
        </div>
        <a class="${styles["direction-shop"]}" target="_blank" rel="noopener noreferrer" href="https://www.google.com/maps/dir/?api=1&query=${lng},${lat}&destination=${shop.address}&travelmode=driving">
          <p>行き方を調べる</p>
        </a>
      </div>`;
  };

  useEffect(() => {
    if (map.current) return;
    // 現在地取得
    navigator.geolocation.getCurrentPosition((position) => {
      setLng(position.coords.longitude);
      setLat(position.coords.latitude);
    });
    // if (!Object.keys(navigator.geolocation).length) {
    //   alert("位置情報を許可してください。");
    //   setLat(1);
    //   setLng(1);
    // } else {
    (async () => {
      if (mapContainer.current)
        map.current = new mapboxgl.Map({
          container: mapContainer.current,
          style: "mapbox://styles/inuiyuki0904/cl9iyv4we000015pbhkvkmoa9",
          center: [lng, lat],
          zoom: 15,
        });
      lng &&
        lat &&
        data.map(async (shop) => {
          await new mapboxgl.Marker(createHomeMarkerElement())
            .setLngLat([lng, lat])
            .addTo(map.current);
          await new mapboxgl.Marker(createMarkerElement(shop))
            .setLngLat(shop.longlat)
            .setPopup(
              new mapboxgl.Popup({ offset: [0, -40] }).setHTML(
                createPopupHTML(shop)
              )
            )
            .addTo(map.current);
        });
    })();
    // }
  }, [lng, lat]);

  return (
    <div className={styles.container}>
      <Head>
        <title>A Cup of Coffee</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/coffee-pink.png" />
      </Head>
      {lat && lng ? (
        <div className={styles.map} ref={mapContainer}></div>
      ) : (
        <Loading />
      )}
    </div>
  );
};

export const getServerSideProps = async () => {
  const ref = collection(db, "store_tokyo");
  // const Docs = await getDocs(query(ref, limit(20)));
  const Docs = await getDocs(ref);
  const data = Docs.docs.map((doc) => doc.data());

  const completeData = data.map((shop) => {
    return {
      store_name: shop.store_name || "",
      brand_name: shop.store_brand || "",
      address: shop.address || "",
      open_time: shop.open_time || "",
      brand_item: shop.brand_item || "",
      phone_number: shop.phone || "",
      brand_price: shop.brand_price || 0,
      longlat: [shop.longlat.longitude, shop.longlat.latitude] || [],
    };
  });

  return {
    props: {
      data: completeData,
    },
  };
};

export default Home;
